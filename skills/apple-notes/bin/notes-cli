#!/usr/bin/env node
'use strict';

const { Command } = require('commander');
const { cmdList, cmdRead, cmdSearch, cmdFolders } = require('../src/commands-read');
const { cmdCreate, cmdAppend, cmdMove, cmdDelete } = require('../src/commands-write');
const { cmdAttachments, cmdExtract, cmdChecklists } = require('../src/commands-attachments');

const program = new Command();

program
  .name('notes-cli')
  .description('Apple Notes CLI - read and write Apple Notes from the command line');

// list
program
  .command('list')
  .description('List notes')
  .option('--folder <name>', 'Filter by folder name')
  .option('--limit <n>', 'Limit number of results', parseInt)
  .option('--pinned', 'Show only pinned notes')
  .option('--include-deleted', 'Include deleted notes')
  .option('--human', 'Human-readable table output')
  .action((opts) => {
    run(() => cmdList({
      folder: opts.folder,
      limit: opts.limit,
      pinned: opts.pinned,
      includeDeleted: opts.includeDeleted,
      human: opts.human,
    }));
  });

// read
program
  .command('read <note_id>')
  .description('Read a note')
  .option('--format <fmt>', 'Output format (text, markdown, json, html)', 'json')
  .action((noteId, opts) => {
    run(() => cmdRead(noteId, opts.format));
  });

// search
program
  .command('search <query>')
  .description('Search notes')
  .option('--folder <name>', 'Filter by folder name')
  .option('--include-deleted', 'Include deleted notes')
  .action((query, opts) => {
    run(() => cmdSearch(query, {
      folder: opts.folder,
      includeDeleted: opts.includeDeleted,
    }));
  });

// folders
program
  .command('folders')
  .description('List all folders')
  .action(() => {
    run(() => cmdFolders());
  });

// attachments
program
  .command('attachments <note_id>')
  .description('List attachments for a note')
  .action((noteId) => {
    run(() => cmdAttachments(noteId));
  });

// extract
program
  .command('extract <attachment_id>')
  .description('Extract an attachment to disk')
  .option('--output <path>', 'Output file path')
  .action((attachmentId, opts) => {
    run(() => cmdExtract(attachmentId, { output: opts.output }));
  });

// checklists
program
  .command('checklists <note_id>')
  .description('Show checklist items for a note')
  .action((noteId) => {
    run(() => cmdChecklists(noteId));
  });

// create
program
  .command('create')
  .description('Create a new note')
  .requiredOption('--folder <name>', 'Folder name')
  .requiredOption('--title <title>', 'Note title')
  .requiredOption('--body <body>', 'Note body content')
  .option('--format <fmt>', 'Body format (text, markdown, html)', 'text')
  .action((opts) => {
    run(() => cmdCreate({
      folder: opts.folder,
      title: opts.title,
      body: opts.body,
      bodyFormat: opts.format,
    }));
  });

// append
program
  .command('append <note_id>')
  .description('Append content to a note')
  .requiredOption('--body <body>', 'Content to append')
  .option('--format <fmt>', 'Body format (text, markdown, html)', 'text')
  .action((noteId, opts) => {
    run(() => cmdAppend(noteId, {
      body: opts.body,
      bodyFormat: opts.format,
    }));
  });

// move
program
  .command('move <note_id>')
  .description('Move a note to a different folder')
  .requiredOption('--folder <name>', 'Destination folder name')
  .action((noteId, opts) => {
    run(() => cmdMove(noteId, { folder: opts.folder }));
  });

// delete
program
  .command('delete <note_id>')
  .description('Delete a note (move to trash)')
  .action((noteId) => {
    run(() => cmdDelete(noteId));
  });

function run(fn) {
  try {
    const result = fn();
    if (typeof result === 'string') {
      console.log(result);
    } else {
      console.log(JSON.stringify(result, null, 2));
    }
  } catch (err) {
    console.error(JSON.stringify({ error: err.message }, null, 2));
    process.exit(1);
  }
}

program.parse();
